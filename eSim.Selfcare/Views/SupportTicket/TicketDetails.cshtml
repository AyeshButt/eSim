@using eSim.Infrastructure.DTOs.Global
@using eSim.Infrastructure.DTOs.Selfcare.Ticket
@model Result<TicketDetailDTO>


@{
    ViewBag.Title = "Ticket Details";
    Layout = null;
}
<!doctype html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    @Html.Partial("~/Views/Shared/_title_meta.cshtml")

    @Html.Partial("~/Views/Shared/_head_css.cshtml")
</head>
<body>
    <!-- Begin page -->
    <div id="layout-wrapper">
        @Html.Partial("~/Views/Shared/_menu.cshtml")



        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mt-n4 mx-n4 mb-n5">
                                <div class="bg-warning-subtle">
                                    <div class="card-body pb-4 mb-5">
                                        <div class="row">
                                            <div class="col-md">
                                                <div class="row align-items-center">
                                                    <div class="col-md-auto">
                                                        <div class="avatar-md mb-md-0 mb-4">
                                                            <div class="avatar-title bg-white rounded-circle">
                                                                <img src="~/assets/images/companies/img-4.png" alt="" class="avatar-sm" />
                                                            </div>
                                                        </div>
                                                    </div><!--end col-->
                                                    <div class="col-md">
                                                        <h4 class="fw-semibold" id="ticket-title">@Model.Data.Subject</h4>
                                                        <div class="hstack gap-3 flex-wrap">
                                                            <div class="text-muted"><i class="ri-building-line align-bottom me-1"></i><span id="ticket-client">
                                                                    @if (@Model.Data.TicketType == 1)
                                                                    {
                                                                        <text>Bundle</text>
                                                                    }
                                                                    else
                                                                    {
                                                                        <text>Payment</text>
                                                                    }
                                                                </span></div>
                                                            <div class="vr"></div>
                                                            <div class="text-muted">Create Date : <span class="fw-medium " id="create-date">@Model.Data.CreatedAt</span></div>
                                                            <div class="vr"></div>
                                                            @* <div class="text-muted">Due Date : <span class="fw-medium" id="due-date">29 Dec, 2021</span></div> *@
                                                            @* <div class="vr"></div> *@
                                                            @* <div class="badge rounded-pill bg-info fs-12" id="ticket-status">New</div> *@
                                                            @* <div class="badge rounded-pill bg-danger fs-12" id="ticket-priority">High</div> *@
                                                        </div>
                                                    </div><!--end col-->
                                                </div><!--end row-->
                                            </div><!--end col-->
                                            @*  <div class="col-md-auto mt-md-0 mt-4">
                                                <div class="hstack gap-1 flex-wrap">
                                                    <button type="button" class="btn avatar-xs mt-n1 p-0 favourite-btn active">
                                                        <span class="avatar-title bg-transparent fs-15">
                                                            <i class="ri-star-fill"></i>
                                                        </span>
                                                    </button>
                                                    <button type="button" class="btn py-0 fs-16 text-body" id="settingDropdown" data-bs-toggle="dropdown">
                                                        <i class="ri-share-line"></i>
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="settingDropdown">
                                                        <li><a class="dropdown-item" href="#"><i class="ri-eye-fill align-bottom me-2 text-muted"></i> View</a></li>
                                                        <li><a class="dropdown-item" href="#"><i class="ri-share-forward-fill align-bottom me-2 text-muted"></i> Share with</a></li>
                                                        <li><a class="dropdown-item" href="#"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> Delete</a></li>
                                                    </ul>
                                                    <button type="button" class="btn py-0 fs-16 text-body">
                                                        <i class="ri-flag-line"></i>
                                                    </button>
                                                </div>
                                            </div> *@<!--end col-->
                                        </div><!--end row-->
                                    </div><!-- end card body -->
                                </div>
                            </div><!-- end card -->
                        </div><!-- end col -->
                    </div><!-- end row -->

                    <div class="row">
                        <div class="col-xxl-9">
                            <div class="card">
                                <div class="card-body p-4">
                                    <h6 class="fw-semibold text-uppercase mb-3">Ticket Discripation</h6>
                                    <p class="text-muted">@Model.Data.Description</p>
                                    @* <h6 class="fw-semibold text-uppercase mb-3">Create an Excellent UI for a Dashboard</h6>
                                    <ul class="text-muted vstack gap-2 mb-4">
                                        <li>Pick a Dashboard Type</li>
                                        <li>Categorize information when needed</li>
                                        <li>Provide Context</li>
                                        <li>On using colors</li>
                                        <li>On using the right graphs</li>
                                    </ul> *@
                                    <div class="mt-4">
                                        <h6 class="fw-semibold text-uppercase mb-3"></h6>
                                        <div>
                                            @*  <pre class="language-markup rounded-2"><code>var app = document.getElementById(&quot;app&quot;);
                                            var run = (model) =&gt; get(model, &quot;users&quot;, () =&gt;
                                                get(model, &quot;posts&quot;,
                                                () =&gt; {
                                                    model.users.forEach(user =&gt; model.userIdx[user.id] = user);
                                                    app.innerText = '';
                                                    model.posts.forEach(post =&gt;
                                                    app.appendChild(renderPost(post, model.userIdx[post.userId])));
                                                }));
                                            app.appendChild(Wrapper.generate(&quot;button&quot;, &quot;Load&quot;).click(() =&gt; run({
                                                userIdx: {}
                                            })).element);</code></pre> *@
                                        </div>
                                    </div>
                                </div><!--end card-body-->  
                                <div class="card-body p-4">
                                    <h5 class="card-title mb-4">Comments</h5>

                                    <div data-simplebar style="height: 300px;" class="px-3 mx-n3">
                                        @if (Model.Data != null && Model.Data.Comments.Any())
                                        {
                                            foreach (var comment in Model.Data.Comments)
                                            {
                                                <div class="d-flex mb-4">
                                                    <div class="flex-shrink-0">
                                                        <img src="~/assets/images/users/avatar-8.jpg" alt="" class="avatar-xs rounded-circle" />
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <h5 class="fs-13">
                                                            @comment.ActivityBy
                                                            <small class="text-muted">@comment.ActivityAt.ToString("dd MMM yyyy - hh:mmtt")</small>
                                                        </h5>
                                                        <p class="text-muted">@comment.Comment</p>
                                                        <a href="javascript:void(0);" class="badge text-muted bg-light">
                                                            <i class="mdi mdi-reply"></i> Reply
                                                        </a>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <p class="text-muted">No comments found for this ticket.</p>
                                        }
                                    </div>

                                    <!-- Comment input form (you can make it functional later) -->
                                    <form asp-action="PostComment" method="post" class="mt-3">
                                        <input type="hidden" name="TRN" value="@Model.Data.TRN" />
                                        <input type="hidden" name="ActivityBy" value="@User.Identity.Name" />

                                        <div class="row g-3">
                                            <div class="col-lg-12">
                                                <label for="Comment" class="form-label">Leave a Comment</label>
                                                <textarea class="form-control bg-light border-light" id="Comment" name="Comment" rows="3" placeholder="Enter comment"></textarea>
                                            </div>
                                            <div class="col-lg-12 text-end">
                                                <button type="submit" class="btn btn-success">Post Comment</button>
                                            </div>
                                        </div>
                                    </form>

                                </div>

                                <!-- end card body -->
                            </div><!--end card-->
                        </div><!--end col-->
                        <div class="col-xxl-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Ticket Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless align-middle mb-0">
                                            <tbody>
                                                <tr>
                                                    <td class="fw-medium">Ticket</td>
                                                    <td>@Model.Data.TRN</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Type</td>
                                                    <td id="t-client">
                                                        @if (@Model.Data.TicketType == 1)
                                                        {
                                                            <text>Bundle</text>
                                                        }
                                                        else
                                                        {
                                                            <text>Payment</text>
                                                        }
                                                    </td>
                                                </tr>
                                                @* <tr>
                                                    <td class="fw-medium">Project</td>
                                                    <td>Velzon - Admin Dashboard</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Assigned To:</td>
                                                    <td>
                                                        <div class="avatar-group">
                                                            <a href="javascript:void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-trigger="hover" data-bs-original-title="Erica Kernan">
                                                                <img src="~/assets/images/users/avatar-4.jpg" alt="" class="rounded-circle avatar-xs" />
                                                            </a>
                                                            <a href="javascript:void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-trigger="hover" data-bs-original-title="Alexis Clarke">
                                                                <img src="~/assets/images/users/avatar-10.jpg" alt="" class="rounded-circle avatar-xs" />
                                                            </a>
                                                            <a href="javascript:void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-trigger="hover" data-bs-original-title="James Price">
                                                                <img src="~/assets/images/users/avatar-3.jpg" alt="" class="rounded-circle avatar-xs" />
                                                            </a>
                                                            <a href="javascript: void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" data-bs-original-title="Add Members">
                                                                <div class="avatar-xs">
                                                                    <div class="avatar-title fs-16 rounded-circle bg-light border-dashed border text-primary">
                                                                        +
                                                                    </div>
                                                                </div>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr> *@
                                                <tr>
                                                    <td class="fw-medium">Status:</td>
                                                    <td>
                                                        @if(Model.Data.Status == 0)
                                                        {
                                                            <text>Completed</text>
                                                        }
                                                        else
                                                        {
                                                            <text>Working ON</text>
                                                        }
                                                        @* <select class="form-select" id="t-status" data-choices data-choices-search-false aria-label="Default select example">
                                                            <option value="">Stauts</option>
                                                            <option value="New" selected>New</option>
                                                            <option value="Open">Open</option>
                                                            <option value="Inprogress">Inprogress</option>
                                                            <option value="Closed">Closed</option>
                                                        </select> *@
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Priority</td>
                                                    <td>
                                                        <span class="badge bg-danger" id="t-priority">High</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Create Date</td>
                                                    <td id="c-date">@Model.Data.CreatedAt</td>
                                                </tr>
                                                @* <tr>
                                                    <td class="fw-medium">Due Date</td>
                                                    <td id="d-date">@Model.Data</td>
                                                </tr> *@
                                                <tr>
                                                    <td class="fw-medium">Last Activity</td>
                                                    <td>14 min ago</td>
                                                </tr>
                                                @* <tr>
                                                    <td class="fw-medium">Labels</td>
                                                    <td class="hstack text-wrap gap-1">
                                                        <span class="badge bg-primary-subtle text-primary">Admin</span>
                                                        <span class="badge bg-primary-subtle text-primary">UI</span>
                                                        <span class="badge bg-primary-subtle text-primary">Dashboard</span>
                                                        <span class="badge bg-primary-subtle text-primary">Design</span>
                                                    </td>
                                                </tr> *@
                                            </tbody>
                                        </table>
                                    </div>
                                </div><!--end card-body-->
                            </div><!--end card-->
                            @* Attachments list from model *@
                            @if (Model.Data.Attachments != null && Model.Data.Attachments.Any())
                            {
                                <div class="card-body">
                                    @foreach (var fileUrl in Model.Data.Attachments)
                                    {
                                        var fileName = System.IO.Path.GetFileName(fileUrl);
                                        var fileExt = System.IO.Path.GetExtension(fileUrl).ToLower();
                                        var baseUrl = "https://localhost:7264/uploads/";


                                        var encodedFileName = Uri.EscapeDataString(fileName); // ✅ Important line
                                        var fullUrl = $"{baseUrl}{encodedFileName}";

                                        var originalFileName = fileName.Contains("_") ? fileName.Split('_', 2)[1] : fileName;

                                        string icon = fileExt switch
                                        {
                                            ".pdf" => "ri-file-pdf-line text-danger",
                                            ".doc" or ".docx" => "ri-file-word-2-line text-primary",
                                            ".ppt" or ".pptx" => "ri-file-ppt-2-line text-warning",
                                            ".xls" or ".xlsx" => "ri-file-excel-2-line text-success",
                                            ".zip" or ".rar" => "ri-file-zip-line text-secondary",
                                            _ => "ri-attachment-line text-muted"
                                        };

                                        <div class="d-flex align-items-center border border-dashed p-2 rounded mt-2">
                                            <div class="flex-shrink-0 avatar-sm">
                                                <div class="avatar-title bg-light rounded">
                                                    <i class="@icon fs-20"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1">
                                                    <a href="@fullUrl" target="_blank">@originalFileName</a>
                                                </h6>
                                            </div>
                                            <div class="hstack gap-3 fs-16">
                                                <a href="@fullUrl" class="text-muted" download="@originalFileName">
                                                    <i class="ri-download-2-line"></i>
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }

                        </div><!--end col-->    
                    </div>
                    <!--end row-->

                </div>
            </div>
            @Html.Partial("~/Views/Shared/_footer.cshtml")
        </div>

    </div>

    
    <!-- END layout-wrapper -->
    @Html.Partial("~/Views/Shared/_customizer.cshtml")

    @Html.Partial("~/Views/Shared/_vendor_scripts.cshtml")

    <!-- ticketdetail init js -->
    <script src="~/assets/js/pages/ticketdetail.init.js"></script>

    <!-- App js -->
    <script src="~/assets/js/app.js"></script>
</body>
</html>